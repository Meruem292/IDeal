rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isSelf(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // --- Collection Rules ---

    match /admins/{userId} {
      allow read, delete: if isAdmin();
      // Only an authenticated user can create their own admin doc, which is later approved.
      // Or an existing admin can create another admin.
      allow create: if isSelf(userId) || isAdmin();
    }

    match /students/{studentId} {
      // Any authenticated user (e.g., during registration) can create a student record.
      allow create: if isAuth(); 
      // An admin or the student themselves can read the profile.
      allow read: if isAdmin() || isSelf(studentId);
      // Only an admin or the student themselves can update their profile (e.g. for RFID).
      allow update: if isAdmin() || isSelf(studentId);
      // Only an admin can delete a student.
      allow delete: if isAdmin();

      // Rules for the attendance sub-collection
      match /attendance/{attendanceId} {
        // An admin can create records (simulating the scanner)
        allow create: if isAdmin();
        // The student themselves or an admin can read the attendance records.
        allow read: if isSelf(studentId) || isAdmin();
        // Only admins can modify or delete specific attendance logs.
        allow update, delete: if isAdmin();
      }
    }

    match /faculty/{facultyId} {
      allow read: if isAuth();
      allow create, update, delete: if isAdmin();
    }
    
    match /sections/{sectionId} {
      allow read: if isAuth();
      allow create, update, delete: if isAdmin();
      
      match /schedules/{scheduleId} {
        allow read: if isAuth();
        allow create, update, delete: if isAdmin();
      }
    }
  }
}
